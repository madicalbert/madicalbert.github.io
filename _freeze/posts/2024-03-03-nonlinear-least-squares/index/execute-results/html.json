{
  "hash": "e0883b53bdac7be9528dc24b04b37db7",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Non-linear Least Squares\"\ndescription: \"Describing and predicting crop yields using non-linear least squares regression models.\"\nauthor:\n  - name: Madison Calbert\n    url: https://madicalbert.github.io/\n    affiliation: ESM 244 Advanced Data Analysis - Master of Environmental Science & Management Program @ The Bren School (UCSB)\n    affiliation-url: https://bren.ucsb.edu/masters-programs/master-environmental-science-and-management \ndate: 03-03-2024\ncategories: [R, Modeling, Data Visualization] # self-defined categories\ncitation: \n  url: https://madicalbert.github.io/posts/2024-03-03-nonlinear-least-squares/ \nimage: preview-image.png\ndraft: false # setting this to `true` will prevent your post from appearing on your listing page until you're ready!\nformat: \n  html: \n    code-fold: true\n    toc: true \n    embed-resources: true\neditor: visual\nexecute: \n  echo: true\n  message: false\n  warning: false\n---\n\n\n\n![Cultivated grain sorghum, El Campo, Texas, 2013. Photo by Lance Cheung, USDA (USDA on flickr, public domain)..](images/sorghum.jpeg)\n\n## Overview\n\n#### Purpose\n\nFarmers need to understand the biology of plants and their responses to fertilizers to maximize yield. In this report, I conduct non-linear least squares on experimental growth data for three grains in Greece to make predictions on their yields. Because many crop and soil processes are better represented by nonlinear models comapred to linear models, nonlinear regression models are used to explore this data.\n\n#### Data Source\n\n\"We used data from [Danalatos et al. (2009)](https://acsess.onlinelibrary.wiley.com/doi/10.2134/agronj2012.0506#bib15), which represent destructive measurements of aboveground biomass accumulation with time for three crops: fiber sorghum (F), sweet sorghum (S), and maize (M), growing in a deep fertile loamy soil of central Greece under two management practices: high and low input conditions, in 2008.\" (Archontoulis 2015). The data used in this report was accessed by installing the \"nlraa\" package and then using library(nlraa).\n\nArchontoulis, S.V. and Miguez, F.E. (2015). Nonlinear Regression Models and Applications in Agricultural Research. Agronomy Journal, Volume 107, Issue 2. Retreived from: https://acsess.onlinelibrary.wiley.com/doi/10.2134/agronj2012.0506\n\n#### Data Summary\n\nThe five variables in the dataset are Day of the Year (DOY), Block, Input, Crop, and Biomass yield in Mg/ha. The data variables are described as follows:\n\n-   Yield = harvested biomass for three crops\n-   Crop = types of crop: maize (M), fiber sorghum (F) and sweet sorghum (S).\n-   Input = two levels of agronomic input, level 1 (Low) or 2 (High)\n-   Block = four blocks in the experimental design (1, 2, 3, or 4)\n-   DOY = \"day of year\"\n\n## PseudoCode\n\n-   Load libraries, load data, clean/tidy the data\n\n-   Run nls on one crop (Sorghum)\n\n    a.  Model Selection\n    b.  Create R Function\n    c.  Define initial Guess\n    d.  Run NLS\n    e.  Evaluate Results\n\n-   Use purrr to run NLS models for all 24 combinations of plot\n\n-   Make a \"good looking\" table\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(nlraa)\nlibrary(tidyverse)\nlibrary(here)\nlibrary(janitor)\nlibrary(Metrics)\nlibrary(cowplot)\nlibrary(nlme)\nlibrary(kableExtra)\nlibrary(purrr)\nlibrary(knitr)\nlibrary(patchwork)\n\n# glimpse(sm)\n\ndata <- sm %>% \n  clean_names()\n```\n:::\n\n\n\n## Model Selection\n\nI use the Beta function:\n\nY = Y~max~ (1 + (t~c~ - t)/(t~c~ - t~m~))(t/t~c~)\\^(t~c~ / (t~c~ - t~m~))\n\n\"This model was selected because it captures the decline of biomass toward the end of the growing season and supplementary figure for the beta growth function. Also, the parameters have clear meaning and are very suitable to answer the research questions.\" (Archontoulis 2015).\n\nThe parameters are defined as:\n\n-   Y is the response variable (e.g., biomass)\n-   t is the explanatory variable (e.g., time),\n-   Y~asym~ or Y~max~ is the asymptotic or the maximum Y value, respectively,\n-   t~m~ is the inflection point at which the growth rate is maximized,\n-   k controls the steepness of the curve,\n-   v deals with the asymmetric growth (if v = I, then Richards' equation becomes logistic),\n-   a and b are parameters that determine the shape of the curve,\n-   t~e~ is the time when Y = Y~asym~\n-   t~c~ is the critical time for a switch-off to occur (eg., critical photoperiod),\n-   n is a parameter that determines the sharpness of the response\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n### build a function\n\nbeta <- function(doy, t_e, t_m, y_max){\n  out = y_max * (1 + (t_e - doy)/ (t_e - t_m)) * (doy/t_e)^(t_e/(t_e - t_m))\n  return(out)\n}\n\ny_max_guess <- 20 \nt_e_guess <- 240\nt_m_guess <- 200\n\n\nguess <- ggplot(data = data, aes(x = doy, y = yield, shape = crop)) + \n  geom_point() +\n  geom_smooth() +\n  facet_wrap(~input, labeller = labeller(input = c(\"2\" = \"High\", \"1\" = \"Low\"))) + \n  labs(x = \"Day of the Year\",\n       y = \" Dry biomass (Mg/ha)\",\n       shape = \"Crop\") +\n  theme_bw()\n```\n:::\n\n\n\n## One Crop NLS\n\nAfter defining the model, building a function, and making initial guesses, I now run the NLS on one crop: the high input sweet sorghum (S) crop. The selected parameter values, standard errors, and p-values of the estimated parameters are displayed in Table 1.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n### Sorghum Fields w/ High Inputs \n\nsm_high <- data %>% filter(crop == \"S\" & input == \"2\")\n\nsm_nls = nls(formula = yield ~ beta(doy, t_e, t_m, y_max), \n               data = sm_high, \n               start = list(t_e = t_e_guess, t_m = t_m_guess, y_max = y_max_guess), \n               trace = FALSE)\n\nsm_nls %>%\n  broom::tidy() %>%\n  mutate(p.value = ifelse(p.value <= 0.05, \"<0.05\")) %>%\n  kbl(digits = 2, align = NULL) %>%\n  kable_classic() \n```\n\n::: {.cell-output-display}\n<table class=\" lightable-classic\" style='font-family: \"Arial Narrow\", \"Source Sans Pro\", sans-serif; margin-left: auto; margin-right: auto;'>\n <thead>\n  <tr>\n   <th> term </th>\n   <th> estimate </th>\n   <th> std.error </th>\n   <th> statistic </th>\n   <th> p.value </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td> t_e </td>\n   <td> 281.59 </td>\n   <td> 2.08 </td>\n   <td> 135.33 </td>\n   <td> &lt;0.05 </td>\n  </tr>\n  <tr>\n   <td> t_m </td>\n   <td> 244.78 </td>\n   <td> 3.51 </td>\n   <td> 69.70 </td>\n   <td> &lt;0.05 </td>\n  </tr>\n  <tr>\n   <td> y_max </td>\n   <td> 39.82 </td>\n   <td> 2.25 </td>\n   <td> 17.71 </td>\n   <td> &lt;0.05 </td>\n  </tr>\n</tbody>\n</table>\n\n\n\nTable 1: The selected parameter values, standard errors, and p-values of the estimated parameters for NLS on the high input sweet sorghum (S) crop.\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nsm_p2 <- sm_high %>%\n  mutate(predict = predict(sm_nls, newdata=.))\n\nggplot(sm_p2, aes(x = doy, y = yield)) +\n  geom_point() +\n  geom_line(aes(x = doy, y = predict), linewidth = 1, color = \"red\")+ \n  labs(x = \"Day of the Year\",\n       y = \" Dry biomass (Mg/ha)\",\n       color = \"Crop\") +\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![The fitted model on top of the the high input sweet sorghum (S) crop data.](index_files/figure-html/fig-1-1.png){#fig-1 width=672}\n:::\n:::\n\n\n\n## NLS for All (using purrr)\n\nNow I run the NLS models for all 24 combinations of plot, input level, and crop type using purrr. Table 2 portrays the RMSE and chosen parameter values of the best fitted models for each species.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n### define a function for NLS for all\n\ncrop <- function(nls_test){\n  nls(yield ~ beta(doy, t_e, t_m, y_max), \n  data = nls_test, \n  start = list(t_e = t_e_guess, t_m = t_m_guess, y_max = y_max_guess))\n}\n\n### purrr\n\nyield_all <- data %>%\n  group_by(block, input, crop) %>%\n  nest() %>%\n  mutate(nls_model = map(data,~crop(.x))) %>%\n  mutate(predictions = map2(nls_model, data, ~predict(.x, newdata = .y))) %>%\n  mutate(rmse = map2_dbl(predictions, data, ~ Metrics::rmse(.x, .y$yield))) %>%\n  mutate(smooth = map(nls_model, ~predict(.x, newdata = list(doy = seq(147, 306)))))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nrmse_table <- yield_all %>% \n  group_by(crop) %>% \n  summarise(rmse = min(rmse))\n\nlow_rmse <- yield_all %>% \n  filter(rmse %in% rmse_table$rmse)\n\nlow_rmse_M <- broom::tidy(low_rmse$nls_model[[1]]) %>% \n  mutate(crop = \"Maize(M)\")\n\n\nlow_rmse_S <- broom::tidy(low_rmse$nls_model[[2]]) %>% \n  mutate(crop = \"Sweet Sorghum (S))\")\n\n\nlow_rmse_F <- broom::tidy(low_rmse$nls_model[[3]]) %>% \n  mutate(crop = \"Fiber Sorgum (F)))\")\n\nlow_rmse_combined <- bind_rows(low_rmse_M, low_rmse_S, low_rmse_F)\n\nlow_rmse_combined <- low_rmse_combined[, c(\"crop\", setdiff(names(low_rmse_combined), \"crop\"))]\n\nlow_rmse_combined %>%\n  kbl(digits = 2, align = NULL) %>%\n  kable_classic() \n```\n\n::: {.cell-output-display}\n<table class=\" lightable-classic\" style='font-family: \"Arial Narrow\", \"Source Sans Pro\", sans-serif; margin-left: auto; margin-right: auto;'>\n <thead>\n  <tr>\n   <th> crop </th>\n   <th> term </th>\n   <th> estimate </th>\n   <th> std.error </th>\n   <th> statistic </th>\n   <th> p.value </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td> Maize(M) </td>\n   <td> t_e </td>\n   <td> 252.57 </td>\n   <td> 1.87 </td>\n   <td> 135.13 </td>\n   <td> 0 </td>\n  </tr>\n  <tr>\n   <td> Maize(M) </td>\n   <td> t_m </td>\n   <td> 225.23 </td>\n   <td> 1.93 </td>\n   <td> 116.92 </td>\n   <td> 0 </td>\n  </tr>\n  <tr>\n   <td> Maize(M) </td>\n   <td> y_max </td>\n   <td> 18.93 </td>\n   <td> 0.84 </td>\n   <td> 22.55 </td>\n   <td> 0 </td>\n  </tr>\n  <tr>\n   <td> Sweet Sorghum (S)) </td>\n   <td> t_e </td>\n   <td> 278.35 </td>\n   <td> 1.82 </td>\n   <td> 153.18 </td>\n   <td> 0 </td>\n  </tr>\n  <tr>\n   <td> Sweet Sorghum (S)) </td>\n   <td> t_m </td>\n   <td> 245.77 </td>\n   <td> 3.82 </td>\n   <td> 64.42 </td>\n   <td> 0 </td>\n  </tr>\n  <tr>\n   <td> Sweet Sorghum (S)) </td>\n   <td> y_max </td>\n   <td> 31.35 </td>\n   <td> 2.05 </td>\n   <td> 15.31 </td>\n   <td> 0 </td>\n  </tr>\n  <tr>\n   <td> Fiber Sorgum (F))) </td>\n   <td> t_e </td>\n   <td> 280.43 </td>\n   <td> 1.84 </td>\n   <td> 152.49 </td>\n   <td> 0 </td>\n  </tr>\n  <tr>\n   <td> Fiber Sorgum (F))) </td>\n   <td> t_m </td>\n   <td> 245.00 </td>\n   <td> 3.54 </td>\n   <td> 69.24 </td>\n   <td> 0 </td>\n  </tr>\n  <tr>\n   <td> Fiber Sorgum (F))) </td>\n   <td> y_max </td>\n   <td> 29.06 </td>\n   <td> 1.66 </td>\n   <td> 17.53 </td>\n   <td> 0 </td>\n  </tr>\n</tbody>\n</table>\n\n\n\nTable 2: The RMSE and chosen parameter values of the best fitted models for each species -- fiber sorghum (F), sweet sorghum (S), and maize (M).\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Unnest predictions from data and clean maize data\nun_df <- yield_all %>% \n  filter(block==1) %>% \n  tidyr::unnest(smooth) %>% \n  mutate(doy=seq(147,306)) %>% \n  filter(!(doy>263 & crop==\"M\"))\n\n# Create a dataframe to add corn data\nhi_filter <- data %>% \n  filter(block == 1 & input == 2)\n\nlow_filter <- data %>% \n  filter(block == 1 & input == 1)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Make graphs\nhi_plot <- un_df %>%\n  filter(block == 1 & input == 2) %>%\n  ggplot() +\n  geom_point(data = hi_filter, aes(x = doy, y = yield, shape = crop)) +\n  geom_line(aes(x = doy, y = smooth, linetype = crop)) +labs(y = \" \", x = \"DOY\", color = \" \")+\n  theme_minimal()\n\n# hi_plot\n\n\nlow_plot<-un_df |> \n  filter(block==1 & input==1) |> \n  ggplot()+\n  geom_point(data=low_filter,aes(x=doy,y=yield,shape=crop))+\n  geom_line(aes(x=doy,y=smooth,linetype=crop))+\n  labs(y = \"Biomass Yield\", x = \"DOY\", color = \"\")+\n  theme_minimal()\n\n# low_plot\n\n\ncombined_plot <- low_plot + hi_plot\n\ncombined_plot + plot_layout(guides = \"collect\") + plot_annotation(tag_levels = \"A\")\n```\n\n::: {.cell-output-display}\n![Figure 2: Observed data and fit for the final model for three crops: maize (M), fiber sorghum (F), and sweet sorghum (S) within Block 1. Plot A is the low input crops and Plot B is the high input crops.](index_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}